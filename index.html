<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataLeak</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-950">

    <h1 class="font-mono m-3 text-white text-2xl text-center">DataLeake</h1>
    <hr class="mb-2 h-0.5 border-t-0 bg-neutral-100 dark:bg-white/10 w-full" />

    <div id="categories-root"></div>

</body>

<script src="js/supabaseClient.js"></script>

<script src="js/components/cardComponent.js"></script>
<script src="js/components/sectionCategoryComponent.js"></script>

<script>
    let supabase = window.supabase.createClient(
        "https://buykkihkvljctcahbsjq.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1eWtraWhrdmxqY3RjYWhic2pxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTM2MDAsImV4cCI6MjA3ODYyOTYwMH0.laSDQ4L4q7XlS3t7UrFMAEXVMKY2yCH9CzyNiyjCKwo"
    );
</script>

<script>
    async function downloadBook(filePath) {
        const { data, error } = await supabase.storage
            .from("dataleake")
            .createSignedUrl(filePath, 3600);
        window.open(data.signedUrl, "_blank");
    }
</script>

<script>
    var COLORS = {
        gray: "bg-gray",
        red: "bg-red",
        blue: "bg-blue",
        green: "bg-green",
        orange: "bg-orange",
        amber: "bg-amber",
        yellow: "bg-yellow",
        orange: "bg-orange",
    };
</script>

<script>
    async function getPdfSignedUrl(filePath) {
        const { data, error } = await supabase.storage
            .from("dataleake")
            .createSignedUrl(filePath, 3600);
        console.log(error)
        return data?.signedUrl;
    }
</script>

<script>
    async function loadCategory(categoryName, containerId) {

        const container = document.getElementById(containerId);

        const { data, error } = await supabase
            .from("db_dataleake")
            .select("*")
            .contains("category", [categoryName]);

        for (const book of data) {
            const card = htmlCardComponent(
                COLORS[book.color],
                book.url_image,
                book.title,
                book.author,
                book.file_path,
            );
            container.insertAdjacentHTML("beforeend", card);
        }
    }
</script>

<script>
    async function loadAllCategories() {
        const { data, error } = await supabase
            .from("db_dataleake")
            .select("category");

        const categories = new Set();

        for (const row of data) {
            if (Array.isArray(row.category)) {
                row.category.forEach(cat => categories.add(cat));
            }
        }

        return Array.from(categories);
    }
</script>

<script>
    async function initDynamicCategories() {

        const categories = await loadAllCategories();
        const root = document.getElementById("categories-root");

        for (const category of categories) {
            const containerId = `category-${category.toLowerCase().replace(/\s+/g, "_")}-catalog`;

            const section = htmlSectionCategoryComponent(category, containerId);

            root.insertAdjacentHTML("beforeend", section);

            loadCategory(category, containerId);
        }
    }

    initDynamicCategories();

</script>

</html>