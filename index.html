<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataLeak</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-950">
</body>

<script src="js/supabaseClient.js"></script>

<script src="js/components/headerComponent.js"></script>
<script src="js/components/navbarComponent.js"></script>
<script src="js/components/cardComponent.js"></script>
<script src="js/components/sectionCategoryComponent.js"></script>
<script src="js/components/footerComponent.js"></script>

<script>
    function loadHeader() {
        const body = document.querySelector('body');
        body.insertAdjacentHTML("afterbegin", htmlHeaderComponent());
    }

    loadHeader();
</script>

<script>
    function loadNavbar() {
        const body = document.querySelector('body');
        body.insertAdjacentHTML("beforeend", htmlNavbarComponent());
    }
    loadNavbar();
</script>

<script>
    async function downloadBook(filePath) {
        const { data, error } = await supabase.storage
            .from("dataleake")
            .createSignedUrl(filePath, 3600);
        window.open(data.signedUrl, "_blank");
    }
</script>

<script>
    var COLORS = {
        gray: "bg-gray",
        red: "bg-red",
        blue: "bg-blue",
        green: "bg-green",
        orange: "bg-orange",
        amber: "bg-amber",
        yellow: "bg-yellow",
        orange: "bg-orange",
        purple: "bg-purple",
        teal: "bg-teal",
        cyan: "bg-cyan",
        sky: "bg-sky",
    };
</script>

<script>
    async function getPdfSignedUrl(filePath) {
        const { data, error } = await supabase.storage
            .from("dataleake")
            .createSignedUrl(filePath, 3600);
        return data?.signedUrl;
    }
</script>

<script>
    async function loadCategory(categoryName, containerId) {

        const container = document.getElementById(containerId);

        const { data, error } = await supabase
            .from("db_dataleake")
            .select("*")
            .contains("category", [categoryName]);

        for (const book of data) {
            const card = htmlCardComponent(
                COLORS[book.color],
                book.url_image_front_cover,
                book.url_image_back_cover,
                book.title,
                book.author,
                book.file_path,
            );
            container.insertAdjacentHTML("beforeend", card);
        }
    }
</script>

<script>
    async function loadAllCategories() {
        const { data, error } = await supabase
            .from("db_dataleake")
            .select("category");

        const categories = new Set();

        for (const row of data) {
            if (Array.isArray(row.category)) {
                row.category.forEach(cat => categories.add(cat));
            }
        }

        return Array.from(categories);
    }
</script>

<script>
    async function initDynamicCategories() {
        const body = document.querySelector('body');
        
        body.insertAdjacentHTML("beforeend", '<div id="categories-root"></div');

        const categories = await loadAllCategories();

        const root = document.getElementById("categories-root");

        for (const category of categories) {
            const containerId = `category-${category.toLowerCase().replace(/\s+/g, "_")}-catalog`;

            const section = htmlSectionCategoryComponent(category, containerId);

            root.insertAdjacentHTML("beforeend", section);

            loadCategory(category, containerId);
        }
    }

    initDynamicCategories();

</script>

<script>
    function loadFooter() {
        const body = document.querySelector('body');
        body.insertAdjacentHTML("beforeend", htmlFooterComponent());
    }
    loadFooter();
</script>

</html>
